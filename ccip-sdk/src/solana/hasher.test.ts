import assert from 'node:assert'
import { before, describe, it } from 'node:test'
import util from 'node:util'

import { encodeBase64, toBigInt } from 'ethers'

import SELECTORS from '../selectors.ts'
import { CCIPVersion } from '../types.ts'
import { getV16SolanaLeafHasher } from './hasher.ts'
import type { CCIPMessage_V1_6_Solana } from './types.ts'

util.inspect.defaultOptions.maxArrayLength = null

describe('MessageHasher', () => {
  before(async () => {
    Object.assign(SELECTORS, {
      solanaLocalGenesisHash: {
        name: 'solana-localnet',
        selector: 78n,
      },
      1339: {
        name: 'test-zetanet',
        selector: 67n,
      },
    })
  })
  // https://github.com/smartcontractkit/chainlink-ccip/blob/34a541118d89c346e2c642b089a63c3f2b2df320/chains/solana/utils/ccip/ccip_messages_test.go#L28
  it('should handle a message to solana', async () => {
    const message = {
      messageId: '0x0805030000000000000000000000000000000000000000000000000000000000',
      sourceChainSelector: 67n,
      destChainSelector: 78n,
      nonce: 90n,
      sequenceNumber: 89n,
      sender: '0x0102030000000000000000000000000000000000000000000000000000000000',
      data: encodeBase64('0x040506'),
      feeToken: '0x',
      receiver: '',
      tokenAmounts: [
        {
          sourcePoolAddress: '0x00010203',
          destTokenAddress: 'DS2tt4BX7YwCw7yrDNwbAdnYrxjeCPeGJbHmZEYC8RTc',
          destGasAmount: 100n,
          destExecData: '',
          extraData: '0x040506',
          amount: toBigInt('0x0101010101010101010101010101010101010101010101010101010101010101'),
        },
      ],
      feeValueJuels: 0n,
      feeTokenAmount: 0n,
      extraArgs: '', // decoded extraArgs below
      computeUnits: 1_000n,
      accountIsWritableBitmap: 1n,
      allowOutOfOrderExecution: false,
      tokenReceiver: 'DS2tt4BX7YwCw7yrDNwbAdnYrxjeCPeGJbHmZEYC8RTb',
      accounts: [
        'C8WSPj3yyus1YN3yNB6YA5zStYtbjQWtpmKadmvyUXq8',
        'CtEVnHsQzhTNWav8skikiV2oF6Xx7r7uGGa8eCDQtTjH',
      ],
    } as CCIPMessage_V1_6_Solana
    const onRamp = '0x010203'
    const lane = {
      sourceChainSelector: message.sourceChainSelector,
      destChainSelector: message.destChainSelector,
      onRamp: onRamp,
      version: CCIPVersion.V1_6,
    }

    const hasher = getV16SolanaLeafHasher(lane)

    const finalHash = hasher(message)

    assert.strictEqual(
      finalHash,
      '0xbd8025f7b32386d93be284b6b4eb6f36c7b46ea157c0228f00ccba38fe7a448e',
    )
  })

  it('should handle a real evm->solana', async () => {
    // https://sepolia.etherscan.io/tx/0xeadc3927a3b6dd10be68a5d3c7a488cf3d99cd8d645ae196406267c833e3e638
    const message = {
      messageId: '0x97d0f914165cb7b281128f0a694e2d4887579dc1289cc59573adb205682ff262',
      sourceChainSelector: 16015286601757825753n,
      destChainSelector: 16423721717087811551n,
      sequenceNumber: 1060n,
      nonce: 0n,
      sender: '0x28b8e36c9642AeaD020289a5Dd5aEE9F9DcA51BE',
      data: '0x0000000000003e80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
      receiver: 'D66KPujkoA2B81z2vUnmAa9PdzMbdXrVdiZ9otxUPevd',
      extraArgs:
        '0x1f3b3aba000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000001806221b5dd6a563bcdc1a39e20539bb8b9da5849d6751133cb44d5702fed1f1400000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000032b4c0e1c22b4ecbb7650755cdf3e6ae0815d71cd6828cf1ae9bb57fb37be51bd36b59f124bfe0e67767a2333b5f0d4956074bb4d2b221f2873812988278afd640000000000000000000000000000000000000000000000000000000000000000',
      feeToken: '0x097D90c9d3E0B50Ca60e1ae45F6A81010f9FB534',
      feeTokenAmount: 116601365075380n,
      feeValueJuels: 23321789221322677n,
      tokenAmounts: [
        {
          sourcePoolAddress: '0x550B43420Ff1ee9625488c509C89b89883062E4F',
          destTokenAddress: '4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU',
          extraData:
            '0x000000000000000000000000000000000000000000000000000000000009619b0000000000000000000000000000000000000000000000000000000000000000',
          amount: 10000n,
          destExecData: '0x000000000000000000000000000000000000000000000000000000000004e200',
          destGasAmount: 320000n,
        },
      ],
      computeUnits: 100_000n,
      accountIsWritableBitmap: 3n,
      allowOutOfOrderExecution: true,
      tokenReceiver: '9e9yTkeXWKbhnTTRqeLnZtAQBCttFKP9Wwk2Scmefdgo',
      accounts: [
        '3v1o5pEb7X5PC6zRxyA4QcVC9tysG73hcRAKomsDtARJ',
        '4gZeGWfSVfKpnJnusHAC7bSwgftT1uz1Bo459xZFfX3h',
        '11111111111111111111111111111111',
      ],
    } as CCIPMessage_V1_6_Solana
    const onRamp = '0x32f88479DC6e9eebE603Ee032161387B96337Fff'
    const lane = {
      sourceChainSelector: message.sourceChainSelector,
      destChainSelector: message.destChainSelector,
      onRamp: onRamp,
      version: CCIPVersion.V1_6,
    }

    const hasher = getV16SolanaLeafHasher(lane)

    const finalHash = hasher(message)

    assert.strictEqual(
      finalHash,
      '0x7a498ae46f8f32c55958a0ca3d3c1cf40ab28ded8fa36bfc3faa9ec3fc46a731',
    )
  })
})
